{% extends 'base.html' %}

{% block title %}PWOA — Add Tasks{% endblock %}

{% block content %}
<div class="space-y-6">
  <div class="flex items-center justify-between">
    <h2 class="text-2xl font-semibold">Add Tasks</h2>
    <a href="/ui/tasks" class="text-indigo-600 hover:underline">Tasks</a>
  </div>

  <div class="grid md:grid-cols-3 gap-6">
    <div class="md:col-span-2 bg-white rounded shadow p-4">
      <h5 class="text-lg font-medium">Extract from Text</h5>
      <form id="text-form" class="mt-2">
        <textarea id="text-input" name="text" class="w-full border rounded p-2" rows="6" placeholder="Paste email, notes, or text here..."></textarea>
        <div class="mt-3"><button class="bg-indigo-600 text-white px-3 py-1 rounded">Extract</button></div>
      </form>

      <hr class="my-4"/>

      <h5 class="text-lg font-medium">Upload PDFs / Images</h5>
      <form id="upload-form" enctype="multipart/form-data" class="mt-2">
        <input type="file" name="files" multiple class="w-full" accept=".pdf,image/*">
        <div class="mt-3"><button class="bg-indigo-600 text-white px-3 py-1 rounded">Upload & Extract</button></div>
      </form>

      <div id="results" class="mt-4"></div>
      <div id="confirm-area" class="mt-4"></div>
    </div>

    <div class="bg-white rounded shadow p-4">
      <h5 class="text-lg font-medium">Info</h5>
      <p class="text-sm text-gray-600">Extraction will use an LLM if the server has `OPENAI_API_KEY` configured. Otherwise a simple rule-based fallback parser will be used.</p>
      <p class="text-sm text-gray-600">PDF extraction uses PyMuPDF if installed. Image OCR uses Tesseract/pytesseract if available.</p>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
  async function postJson(url, body){
    const res = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });
    return res;
  }

  document.getElementById('text-form').addEventListener('submit', async function(e){
    e.preventDefault();
    const text = e.target.text.value.trim();
    if(!text) return showToast('Please enter text to extract','error');

    const res = await postJson('/api/extract/text', {text});
    const out = document.getElementById('results');
    const confirmArea = document.getElementById('confirm-area');
    if(res.ok){
      const data = await res.json();
      out.innerHTML = '<h6 class="font-medium">Extracted (preview)</h6>' + renderTasks(data.tasks);
      confirmArea.innerHTML = renderConfirmForm(data.tasks);
    } else {
      out.innerHTML = '<div class="text-red-600">Extraction failed</div>';
    }
  });

  document.getElementById('upload-form').addEventListener('submit', async function(e){
    e.preventDefault();
    const form = e.target;
    const filesElem = form.querySelector('input[type=file]');
    const files = filesElem.files;
    if(!files || files.length===0) return showToast('Please select files to upload','error');

    const fd = new FormData();
    for(let i=0;i<files.length;i++) fd.append('files', files[i]);

    try{
      const res = await fetch('/api/extract/upload', {method: 'POST', body: fd});
      const out = document.getElementById('results');
      const confirmArea = document.getElementById('confirm-area');
      if(res.ok){
        const data = await res.json();
        out.innerHTML = '<h6 class="font-medium">Extracted (preview)</h6>' + renderTasks(data.tasks);
        confirmArea.innerHTML = renderConfirmForm(data.tasks);
      } else {
        out.innerHTML = '<div class="text-red-600">Upload/extract failed</div>';
      }
    }catch(err){
      showToast('Error uploading files','error');
    }
  });

  function renderTasks(tasks){
    if(!tasks || tasks.length===0) return '<div class="text-gray-500">No tasks extracted.</div>';
    let html = '<ul class="space-y-2">';
    for(const t of tasks){
      html += `<li class="p-2 border rounded">` +
              `<strong>${t.description}</strong><br/>` +
              `<span class="text-sm text-gray-600">Category: ${t.category} • Priority: ${t.priority} • Est: ${t.estimated_time_minutes} min</span>` +
              `</li>`;
    }
    html += '</ul>';
    return html;
  }

  function renderConfirmForm(tasks){
    if(!tasks || tasks.length===0) return '';
    let html = '<h6 class="font-medium">Confirm & Edit Extracted Tasks</h6>';
    html += '<form id="confirm-form" class="space-y-3">';
    tasks.forEach((t, idx) => {
      html += `<div class="border rounded p-3">
        <div class="mb-2"><label class="block text-sm">Description</label><input class="w-full border rounded px-2 py-1" name="description_${idx}" value="${escapeHtml(t.description || '')}"></div>
        <div class="mb-2"><label class="block text-sm">Deadline</label><input class="w-full border rounded px-2 py-1" name="deadline_${idx}" value="${t.deadline || ''}"></div>
        <div class="mb-2"><label class="block text-sm">Estimated (min)</label><input class="w-full border rounded px-2 py-1" name="estimated_${idx}" value="${t.estimated_time_minutes || 30}"></div>
        <div class="mb-2"><label class="block text-sm">Category</label><input class="w-full border rounded px-2 py-1" name="category_${idx}" value="${t.category || 'misc'}"></div>
        <input type="hidden" name="source_${idx}" value="${t.source || 'text'}">
      </div>`;
    });
    html += '<div><button class="bg-green-600 text-white px-3 py-1 rounded" type="submit">Save All</button></div>';
    html += '</form>';
    html += '<div id="save-result" class="mt-2"></div>';
    // attach handler
    setTimeout(() => {
      const form = document.getElementById('confirm-form');
      if(form) form.addEventListener('submit', async function(ev){
        ev.preventDefault();
        const payload = {tasks: []};
        for(let i=0;i<tasks.length;i++){
          payload.tasks.push({
            description: form[`description_${i}`].value,
            deadline: form[`deadline_${i}`].value || null,
            estimated_time_minutes: parseInt(form[`estimated_${i}`].value || '30'),
            category: form[`category_${i}`].value || 'misc',
            source: form[`source_${i}`].value || 'text'
          });
        }
        const res = await postJson('/api/extract/save', payload);
        const sr = document.getElementById('save-result');
        if(res.ok){
          const data = await res.json();
          sr.innerHTML = '<div class="text-green-600">Saved '+data.tasks.length+' tasks</div>';
          // clear confirm area
          document.getElementById('confirm-area').innerHTML = '';
        } else {
          sr.innerHTML = '<div class="text-red-600">Save failed</div>';
        }
      });
    }, 50);
    return html;
  }

  function escapeHtml(s){
    return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
</script>
{% endblock %}
