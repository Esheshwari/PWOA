<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PWOA - Add Tasks</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Add Tasks</h2>
        <a href="/ui/tasks" class="btn btn-link">Tasks</a>
      </div>

      <div class="row">
        <div class="col-md-7">
          <div class="card mb-3 shadow-sm">
            <div class="card-body">
              <h5>Extract from Text</h5>
              <form id="text-form">
                <div class="mb-2">
                  <textarea id="text-input" name="text" class="form-control" rows="6" placeholder="Paste email, notes, or text here..."></textarea>
                </div>
                <button class="btn btn-primary" type="submit">Extract</button>
              </form>

              <hr/>

              <h5>Upload PDFs / Images</h5>
              <form id="upload-form" enctype="multipart/form-data">
                <div class="mb-2">
                  <input type="file" name="files" multiple class="form-control" accept=".pdf,image/*">
                </div>
                <button class="btn btn-primary" type="submit">Upload & Extract</button>
              </form>

              <hr/>

              <div id="results" class="mt-3"></div>
              <div id="confirm-area" class="mt-3"></div>
            </div>
          </div>
        </div>

        <div class="col-md-5">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5>Info</h5>
              <p class="small text-muted">Extraction will use an LLM if the server has `OPENAI_API_KEY` configured. Otherwise a simple rule-based fallback parser will be used.</p>
              <p class="small text-muted">PDF extraction uses PyMuPDF if installed. Image OCR uses Tesseract/pytesseract if available.</p>
            </div>
          </div>
        </div>
      </div>

    </div>

    <script>
    async function postJson(url, body){
      const res = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });
      return res;
    }

    document.getElementById('text-form').addEventListener('submit', async function(e){
      e.preventDefault();
      const text = e.target.text.value.trim();
      if(!text) return alert('Please enter text to extract');

      const res = await postJson('/api/extract/text', {text});
      const out = document.getElementById('results');
      const confirmArea = document.getElementById('confirm-area');
      if(res.ok){
        const data = await res.json();
        out.innerHTML = '<h6>Extracted (preview)</h6>' + renderTasks(data.tasks);
        // show editable confirm form
        confirmArea.innerHTML = renderConfirmForm(data.tasks);
      } else {
        out.innerHTML = '<div class="alert alert-danger">Extraction failed</div>';
      }
    });

    document.getElementById('upload-form').addEventListener('submit', async function(e){
      e.preventDefault();
      const input = e.target.files;
      const form = e.target;
      const filesElem = form.querySelector('input[type=file]');
      const files = filesElem.files;
      if(!files || files.length===0) return alert('Please select files to upload');

      const fd = new FormData();
      for(let i=0;i<files.length;i++) fd.append('files', files[i]);

      try{
        const res = await fetch('/api/extract/upload', {method: 'POST', body: fd});
        const out = document.getElementById('results');
        const confirmArea = document.getElementById('confirm-area');
        if(res.ok){
          const data = await res.json();
          out.innerHTML = '<h6>Extracted (preview)</h6>' + renderTasks(data.tasks);
          confirmArea.innerHTML = renderConfirmForm(data.tasks);
        } else {
          out.innerHTML = '<div class="alert alert-danger">Upload/extract failed</div>';
        }
      }catch(err){
        alert('Error uploading files');
      }
    });

    function renderTasks(tasks){
      if(!tasks || tasks.length===0) return '<div class="text-muted">No tasks extracted.</div>';
      let html = '<ul class="list-group">';
      for(const t of tasks){
        html += `<li class="list-group-item">` +
                `<strong>${t.description}</strong><br/>` +
                `Category: ${t.category} • Priority: ${t.priority} • Est: ${t.estimated_time_minutes} min` +
                `</li>`;
      }
      html += '</ul>';
      return html;
    }

    function renderConfirmForm(tasks){
      if(!tasks || tasks.length===0) return '';
      let html = '<h6>Confirm & Edit Extracted Tasks</h6>';
      html += '<form id="confirm-form">';
      tasks.forEach((t, idx) => {
        html += `<div class="card mb-2">
          <div class="card-body">
            <div class="mb-2"><label>Description</label><input class="form-control" name="description_${idx}" value="${escapeHtml(t.description || '')}"></div>
            <div class="mb-2"><label>Deadline</label><input class="form-control" name="deadline_${idx}" value="${t.deadline || ''}"></div>
            <div class="mb-2"><label>Estimated (min)</label><input class="form-control" name="estimated_${idx}" value="${t.estimated_time_minutes || 30}"></div>
            <div class="mb-2"><label>Category</label><input class="form-control" name="category_${idx}" value="${t.category || 'misc'}"></div>
            <input type="hidden" name="source_${idx}" value="${t.source || 'text'}">
          </div>
        </div>`;
      });
      html += '<button class="btn btn-success" type="submit">Save All</button>';
      html += '</form>';
      html += '<div id="save-result" class="mt-2"></div>';
      // attach handler
      setTimeout(() => {
        const form = document.getElementById('confirm-form');
        if(form) form.addEventListener('submit', async function(ev){
          ev.preventDefault();
          const payload = {tasks: []};
          for(let i=0;i<tasks.length;i++){
            payload.tasks.push({
              description: form[`description_${i}`].value,
              deadline: form[`deadline_${i}`].value || null,
              estimated_time_minutes: parseInt(form[`estimated_${i}`].value || '30'),
              category: form[`category_${i}`].value || 'misc',
              source: form[`source_${i}`].value || 'text'
            });
          }
          const res = await postJson('/api/extract/save', payload);
          const sr = document.getElementById('save-result');
          if(res.ok){
            const data = await res.json();
            sr.innerHTML = '<div class="alert alert-success">Saved '+data.tasks.length+' tasks</div>';
            // clear confirm area
            document.getElementById('confirm-area').innerHTML = '';
          } else {
            sr.innerHTML = '<div class="alert alert-danger">Save failed</div>';
          }
        });
      }, 50);
      return html;
    }

    function escapeHtml(s){
      return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    </script>
  </body>
</html>
