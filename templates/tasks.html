{% extends 'base.html' %}

{% block title %}PWOA â€” Tasks{% endblock %}

{% block content %}
<div class="space-y-4">
  <div class="flex items-center justify-between">
    <h2 class="text-2xl font-semibold">Tasks</h2>
    <a href="/" class="text-indigo-600 hover:underline">Home</a>
  </div>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, msg in messages %}
              <div class="p-3 rounded {{ 'bg-green-50 text-green-800' if category=='success' else 'bg-yellow-50 text-yellow-800' }}">{{ msg }}</div>
            {% endfor %}
          {% endif %}
      {% endwith %}

      <div class="grid md:grid-cols-3 gap-6">
        <div class="md:col-span-2">
          <div class="bg-white rounded shadow">
            <div class="p-3">
              <table class="min-w-full text-sm" aria-label="Tasks table">
                <thead class="text-left text-xs text-gray-500">
                  <tr>
                    <th class="px-2 py-2">ID</th>
                    <th class="px-2 py-2">Description</th>
                    <th class="px-2 py-2">Priority</th>
                   <th class="px-2 py-2">Priority Score</th>
                   <th class="px-2 py-2">Est. Time</th>
                   <th class="px-2 py-2">Created At</th>
                    <th class="px-2 py-2">Category</th>
                    <th class="px-2 py-2">Status</th>
                    <th class="px-2 py-2">Actions</th>
                  </tr>
                </thead>
                <tbody id="tasks-tbody" class="text-gray-700">
                  {% for t in tasks %}
                  <tr class="border-t">
                    <td class="px-2 py-2">{{ t.priority_score }}</td>
                    <td class="px-2 py-2">{{ t.id }}</td>
                    <td class="px-2 py-2">{{ t.description }}</td>
                    <td class="px-2 py-2">{{ t.priority }}</td>
                    <td class="px-2 py-2">{{ t.category }}</td>
                    <td class="px-2 py-2">{{ t.status }}</td>
                    <td class="px-2 py-2">
                      {% if t.status == 'completed' %}
                        <button class="btn-complete rounded px-2 py-1 bg-green-500 text-white" disabled>Completed</button>
                      {% else %}
                        <form action="/ui/complete/{{ t.id }}" method="post" style="display:inline">
                          <button class="btn-complete rounded px-2 py-1 bg-green-100 text-green-700" type="submit">Complete</button>
                        </form>
                      {% endif %}
                      <form action="/ui/delete/{{ t.id }}" method="post" style="display:inline; margin-left:6px">
                        <button class="btn-delete rounded px-2 py-1 bg-red-100 text-red-700" type="submit">Delete</button>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div>
          <div class="bg-white rounded shadow p-4">
            <h5 class="text-lg font-semibold">Add Task</h5>
            <form id="create-form" action="/ui/create_task" method="post" class="mt-3 space-y-3">
              <div>
                <label class="block text-sm">Description</label>
                <input name="description" class="w-full border rounded px-2 py-1" required>
              </div>
              <div>
                <label class="block text-sm">Category</label>
                <select name="category" class="w-full border rounded px-2 py-1">
                  <option value="work">Work</option>
                  <option value="personal">Personal</option>
                  <option value="learning">Learning</option>
                  <option value="fitness">Fitness</option>
                  <option value="finance">Finance</option>
                  <option value="misc" selected>Misc</option>
                </select>
              </div>
              <div>
                <label class="block text-sm">Estimated time (minutes)</label>
                <input name="estimated_time_minutes" class="w-full border rounded px-2 py-1" value="30">
              </div>
              <div class="flex items-center">
                <input type="checkbox" name="calendar_reminder" id="calendar_reminder" class="mr-2">
                <label for="calendar_reminder" class="text-sm">Add Google Calendar reminder</label>
              </div>
              <div>
                <button class="bg-green-600 text-white px-3 py-1 rounded">Create</button>
              </div>
            </form>
          </div>
        </div>

    <script>
    (function(){
      const bsScript = document.createElement('script');
      bsScript.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js';
      document.head.appendChild(bsScript);
    })();
    // Helper to create a table row for a task object
    function buildRow(task){
      const tr = document.createElement('tr');
      tr.id = `row-${task.id}`;
      tr.setAttribute('data-task-id', task.id);
      tr.innerHTML = `
        <td>${task.id}</td>
        <td>${task.description}</td>
        <td>${task.priority}</td>
        <td>${task.priority_score ?? 0}</td>
        <td>${task.category}</td>
        <td>${task.estimated_time_minutes ?? ''}</td>
        <td>${task.created_at ?? ''}</td>
        <td id="status-${task.id}">${task.status}</td>
        <td>
          <button class="btn btn-sm btn-outline-success btn-complete" data-id="${task.id}">Complete</button>
          <button class="btn btn-sm btn-outline-danger btn-delete ms-1" data-id="${task.id}">Delete</button>
        </td>
      `;
      return tr;
    }

    // Delegate clicks for complete/delete
    document.addEventListener('click', async function(e){
      if(e.target.matches('.btn-complete')){
        const id = e.target.getAttribute('data-id');
        if(!confirm('Mark this task as complete?')) return;
        try{
          const res = await fetch(`/api/tasks/${id}/complete`, {method: 'POST'});
          if(res.ok){
              const updated = await res.json();
              const statusCell = document.getElementById(`status-${id}`);
              if(statusCell) statusCell.textContent = updated.status;
              // update the button to a green completed state
              try{
                e.target.textContent = 'Completed';
                e.target.className = 'btn btn-sm btn-success';
                e.target.disabled = true;
              }catch(err){}
            } else {
            alert('Failed to complete task');
          }
        }catch(err){
          alert('Error completing task');
        }
      }

      if(e.target.matches('.btn-delete')){
        const id = e.target.getAttribute('data-id');
        if(!confirm('Permanently delete this task?')) return;
        try{
          const res = await fetch(`/api/tasks/${id}`, {method: 'DELETE'});
          if(res.status === 204){
            const row = document.getElementById(`row-${id}`);
            if(row) row.remove();
          } else {
            alert('Failed to delete task');
          }
        }catch(err){
          alert('Error deleting task');
        }
      }
    });

    // Create form submit via AJAX
    document.getElementById('create-form').addEventListener('submit', async function(e){
      e.preventDefault();
      const form = e.target;
      const data = {
        description: form.description.value,
        source: 'manual',
        category: form.category.value,
        estimated_time_minutes: parseInt(form.estimated_time_minutes.value || '30')
      };

      try{
        const res = await fetch('/api/tasks', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        if(res.ok){
          const created = await res.json();
          const tbody = document.getElementById('tasks-tbody');
          tbody.prepend(buildRow(created));
          form.reset();
          alert('Task created');
        } else {
          const txt = await res.text();
          alert('Failed to create task: ' + txt);
        }
      }catch(err){
        alert('Error creating task');
      }
    });
    </script>
        </div>
      </div>

  </div>
{% endblock %}

{% block scripts %}
<script>
// Put any page-specific scripts here (table row builder already included)
</script>
{% endblock %}
