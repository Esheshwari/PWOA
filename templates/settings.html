<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PWOA - Settings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
  </head>
  <body class="bg-light">
    {% include '_navbar.html' %}
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Settings</h2>
        <a href="/" class="btn btn-link">Home</a>
      </div>

      <div class="card shadow-sm p-3">
        <h5>Integrations</h5>
        <p>Connect your Gmail and Google Calendar to enable email and calendar features.</p>
        <div class="mb-2">
          <strong>Gmail:</strong>
          {% if gmail_connected %}
            <span class="badge bg-success">Connected</span>
            <a class="btn btn-outline-danger btn-sm ms-2" href="/disconnect/gmail">Disconnect</a>
          {% else %}
            <span class="badge bg-secondary">Not Connected</span>
            <a id="btn-connect-gmail" class="btn btn-outline-primary btn-sm ms-2" href="/connect/gmail">Connect Gmail</a>
          {% endif %}
        </div>
        <div class="mb-2">
          <strong>Google Calendar:</strong>
          {% if calendar_connected %}
            <span class="badge bg-success">Connected</span>
            <a class="btn btn-outline-danger btn-sm ms-2" href="/disconnect/calendar">Disconnect</a>
          {% else %}
            <span class="badge bg-secondary">Not Connected</span>
            <a id="btn-connect-calendar" class="btn btn-outline-primary btn-sm ms-2" href="/connect/calendar">Connect Calendar</a>
          {% endif %}
        </div>
        <hr/>
        <h6>OpenAI</h6>
        <p>Set <code>OPENAI_API_KEY</code> as an environment variable on the server or in your hosting provider's secrets.</p>
      </div>

      <div class="card shadow-sm p-3 mt-3">
        <h5>Communications (Draft Emails)</h5>
        <p>Generate an email draft for a task using the Communication Agent (LLM-backed if `OPENAI_API_KEY` is set).</p>

        <div class="mb-2">
          <label class="form-label">Task ID</label>
          <input id="comm-task-id" class="form-control" placeholder="e.g. task-1a2b3c4d">
        </div>

        <div class="mb-2">
          <label class="form-label">Action</label>
          <select id="comm-action" class="form-select">
            <option value="follow_up">Follow up</option>
            <option value="request_meeting">Request meeting</option>
            <option value="summary">Summary</option>
            <option value="completion_notice">Completion notice</option>
          </select>
        </div>

        <button id="comm-generate" class="btn btn-primary">Generate Draft</button>
        <button id="comm-send" class="btn btn-outline-success ms-2">Send Draft (via Gmail)</button>

        <div class="mt-3">
          <label class="form-label">Draft</label>
          <pre id="comm-draft" class="p-3 bg-white border rounded" style="white-space:pre-wrap;"></pre>
        </div>
      </div>

    </div>
    <script>
      // Intercept connect clicks to check server-side env vars first
      async function checkAndRedirect(provider, href){
        try{
          const resp = await fetch('/api/check_google_creds', {
            method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider})
          });
          const data = await resp.json();
          if(!resp.ok){
            alert('Cannot start OAuth: ' + (data.error || 'missing credentials'));
            return;
          }
          // all good â€” navigate to OAuth endpoint (will redirect to Google)
          window.location = href;
        }catch(err){
          alert('Network error while checking credentials: ' + err.message);
        }
      }

      document.getElementById('comm-generate').addEventListener('click', async function(){
        const taskId = document.getElementById('comm-task-id').value.trim();
        const action = document.getElementById('comm-action').value;
        const out = document.getElementById('comm-draft');
        out.textContent = 'Generating...';

        if(!taskId){
          out.textContent = 'Please enter a task id.';
          return;
        }

        try{
          const resp = await fetch('/api/communications/draft', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_id: taskId, action })
          });
          const data = await resp.json();
          if(!resp.ok){
            out.textContent = data.error || 'Error generating draft';
            return;
          }
          out.textContent = data.draft || JSON.stringify(data, null, 2);
        }catch(err){
          out.textContent = 'Network error: ' + err.message;
        }
      });

      document.getElementById('comm-send').addEventListener('click', async function(){
        const taskId = document.getElementById('comm-task-id').value.trim();
        const action = document.getElementById('comm-action').value;
        const out = document.getElementById('comm-draft');
        if(!taskId){ out.textContent = 'Please enter a task id.'; return; }
        out.textContent = 'Sending...';
        try{
          // attempt to send; server will generate draft if needed
          const resp = await fetch('/api/communications/send', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ task_id: taskId, action })
          });
          const data = await resp.json();
          if(!resp.ok){ out.textContent = data.error || 'Send failed'; return; }
          out.textContent = 'Sent. Server response:\n' + JSON.stringify(data, null, 2);
        }catch(err){ out.textContent = 'Network error: ' + err.message; }
      });

      // Attach handlers to connect buttons (if present)
      const btnG = document.getElementById('btn-connect-gmail');
      if(btnG) btnG.addEventListener('click', function(e){ e.preventDefault(); checkAndRedirect('gmail', '/connect/gmail'); });
      const btnC = document.getElementById('btn-connect-calendar');
      if(btnC) btnC.addEventListener('click', function(e){ e.preventDefault(); checkAndRedirect('calendar', '/connect/calendar'); });

      document.getElementById('comm-generate').addEventListener('click', async function(){
        const taskId = document.getElementById('comm-task-id').value.trim();
        const action = document.getElementById('comm-action').value;
        const out = document.getElementById('comm-draft');
        out.textContent = 'Generating...';

        if(!taskId){
          out.textContent = 'Please enter a task id.';
          return;
        }

        try{
          const resp = await fetch('/api/communications/draft', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_id: taskId, action })
          });
          const data = await resp.json();
          if(!resp.ok){
            out.textContent = data.error || 'Error generating draft';
            return;
          }
          out.textContent = data.draft || JSON.stringify(data, null, 2);
        }catch(err){
          out.textContent = 'Network error: ' + err.message;
        }
      });

      document.getElementById('comm-send').addEventListener('click', async function(){
        const taskId = document.getElementById('comm-task-id').value.trim();
        const action = document.getElementById('comm-action').value;
        const out = document.getElementById('comm-draft');
        if(!taskId){ out.textContent = 'Please enter a task id.'; return; }
        out.textContent = 'Sending...';
        try{
          // attempt to send; server will generate draft if needed
          const resp = await fetch('/api/communications/send', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ task_id: taskId, action })
          });
          const data = await resp.json();
          if(!resp.ok){ out.textContent = data.error || 'Send failed'; return; }
          out.textContent = 'Sent. Server response:\n' + JSON.stringify(data, null, 2);
        }catch(err){ out.textContent = 'Network error: ' + err.message; }
      });
    </script>
  </body>
</html>
